/*!
 * jQuery datagrid
 * 
 * @autor:.....: Juarez Gon√ßalves Nery Junior
 * @email:.....: juareznjunior@gmail.com
 * @twitter:...: @juareznjunior
 * @date.......: 2014-01-29
 * 
 * Use jQueryUI - Depends:
 *	 jquery.ui.core.js
 *	 jquery.ui.widget.js
 *	 jquery.ui.button.js
 * 
 */
;(function(b,x,y,k){var r={options:{limit:20,mapper:[],height:200,jsonStore:{url:"",params:{},data:{}},pagination:!0,refresh:!1,rowNumber:!1,fit:!1,autoRender:!0,autoLoad:!0,ajaxMethod:"GET",title:"",onClickRow:!1,onComplete:!1,onAjaxSuccess:!1,onError:!1,emptyDataMessage:"Empty rows",toolBarButtons:!1},_create:function(){"none"===this.element.css("display")&&this.element.show();var a=[],c;this.uiDataGrid=b(w(k!==this.options.ui?"ui":"bs"));this.uiDataGrid.find("table").filter(function(){b(this).hasClass("ui-datagrid")?
a.push(this):c=this.parentNode.parentNode}).end();""===this.options.title?b(c.parentNode).prev().remove():b(c.parentNode).prev().children().text(this.options.title);!1===b.isArray(this.options.toolBarButtons)&&!1===this.options.pagination&&b(a[3].parentNode).remove();this.uiDataGridThead=b(a[0].tHead);this.uiDataGridLayout=b(a[1].tBodies[0].rows[0]);this.uiDataGridTheadBody=b(a[2].tHead);this.uiDataGridColGroup1=this.uiDataGridThead.prev();this.uiDataGridColGroup2=b(this.uiDataGridLayout[0].parentNode).prev();
this.uiDataGridColGroup3=this.uiDataGridTheadBody.prev();this.uiDataGridTbody=b(a[2].tBodies[0]);this.uiDataGridMsgError=b(a[2]).next();this.uiDataGridTfoot=this.options.pagination||b.isArray(this.options.toolBarButtons)?b(a[3].tBodies[0]):b([]);this.uiDataGridScrollBody=b(a[1].parentNode).height(this.options.height);this.uiDataGridScrollMain=b(c);this.uiDataGridTdPagination={childs:[]};this._selectedRows=[];a=c=null;this._totalPages=this._offset=this._num_rows=0;this.element.on("click.uiDataGridBindClick",
":data(uiDataGridBindClick)",{uiDataGrid:this},function(a){a.preventDefault();a.stopPropagation();var c=b.data(this,"uiDataGridBindClick"),e;k!==c&&("loadPage"===c?!1===this.disabled&&(e=b(a.data.uiDataGrid.uiDataGridTdPagination.childs).filter("button"),a.data.uiDataGrid.options.ui?e.removeClass("ui-state-hover ui-state-focus").button("disable"):e.prop("disabled",!0),e=this.name.split("-").slice(-1),a.data.uiDataGrid["_"+e+"Page"](),a.data.uiDataGrid.load()):(e=a.data.uiDataGrid.options,b.map(c.split(":"),
function(a,b){e=e[a]}),b.isFunction(e)&&e.call(a.data.uiDataGrid.element[0],this)));c=e=null});this._createPagination()},_init:function(){this.options.autoRender&&this.render()},_createColumns:function(){var a=this,c=null,f=null,d=0,e="<col></col>",h='<th class="ui-widget ui-state-default" role="columnheader"></th>',g='<td class="ui-widget ui-widget-content"></td>',l="ui-datagrid-align-",q="ui-datagrid-column-hide",p=a.options.ui,m=b([a.uiDataGridColGroup1[0],a.uiDataGridColGroup2[0],a.uiDataGridColGroup3[0]]).empty(),
s=b([a.uiDataGridThead[0].rows[0],a.uiDataGridTheadBody[0].rows[0]]).empty();a.options.rowNumber&&(m.append(b("<col></col>").addClass("ui-datagrid-cell-rownumber")),s.append('<th class="ui-state-default ui-datagrid-cell-rownumber" role="columnheader"></th>'),a.uiDataGridLayout.append(g),d=20);b.map(a.options.mapper,function(n,z){f=n.title||n.name;d+=n.width||0;c=b(h).html(f);c=c.text(c.text()).data("width",n.width);c.data("text-align",l+(/left|right|center/.test(n.align)?n.align:"left")).addClass(function(){return b(this).data("textAlign")});
!0===n.sort&&c.addClass("ui-datagrid-sort").html(function(a){a=b("<button>"+this.innerHTML+"</button>",{type:"button"});p?a.button({icons:{primary:"",secondary:"ui-icon-carat-2-n-s"}}):a.addClass("btn btn-default").append('<span class="glyphicon glyphicon-sort"></span>');return a});var t=b(g),u=b(e).width(n.width);k!==n.hidden&&b([c.data("hidden",q)[0],u[0],t[0]]).addClass(q);s.append(c);m.append(u);a.uiDataGridLayout.append(t);u=t=n=null});b(a.uiDataGridThead[0].rows[0].cells).slice(0,-1).map(function(c,
d){var e=Math.max(b(d).innerWidth(),b(d).outerWidth()),f=b(d).data("width"),e=Math.max(e,f);a.uiDataGridColGroup1.children().eq(c).width(e);a.uiDataGridColGroup2.children().eq(c).width(e);a.uiDataGridColGroup3.children().eq(c).width(e)});d>a.element.width()&&a.uiDataGridScrollMain.width(d);b(a.uiDataGridTheadBody[0].parentNode.tHead).hide();q=l=g=h=e=c=s=m=null},_createRows:function(a,c,f){var d=this,e=d.getThead()[0].rows[0].cells,h=f?d.uiDataGridTbody[0]:d.uiDataGridTbody.empty()[0],g=f?h.rows.length+
1:d._offset+1,l=!f&&"local"===c&&d.options.pagination,q=d.options.ui,p,m;0===d._num_rows&&(d._num_rows=k===a.num_rows?k===a.rows?k===a[0].num_rows?a.length:a[0].num_rows:k===a.rows[0].num_rows?a.rows.length:a.rows[0].num_rows:a.num_rows);a=a.rows||a;l&&1<g&&(a=a.slice(d._offset));b.map(a,function(a,c){if(l&&c===d.options.limit)return!1;p=h.insertRow(-1);p.className=q?"ui-state-hover":"";b(p).data("row-json",a).data("row-index",g+1);d.options.rowNumber&&b(p.insertCell(0)).addClass("ui-state-default ui-datagrid-cell-rownumber").text(g+
c);b.isFunction(d.options.onClickRow)&&b(p).data("uiDataGridBindClick","onClickRow");b.map(d.options.mapper,function(c,d){m=p.insertCell(-1);m.className="ui-widget ui-widget-content";b.map(b(e[m.cellIndex]).data(),function(a,b){/textAlign|text-align|hidden/.test(b)&&(m.className+=" "+a)});b(m).html(b.isFunction(c.render)?c.render.call(m,a[c.name]):a[c.name])})});f||(this._updatePagination(),d.uiDataGridScrollBody.scrollTop(0));e=h=p=m=d=a=null},_createPagination:function(){if(!0===this.options.pagination){var a=
this,c=b(this.uiDataGridTfoot[0].rows[0].cells).last()[0],f=a.options.ui,d=["step-backward","backward","forward","step-forward"],e;a.uiDataGridTdPagination.childs.push(b(c).children()[0]);b.map(["first","prev","next","end"],function(h,g){e=g;g=b("<button></button>",{type:"button",name:"uiDataGridSetPage-"+h,disabled:!0}).text(h);f?g.button({icons:{primary:"ui-icon-seek-"+h},text:!1}):g.addClass("btn btn-default btn-xs").html('<span class="glyphicon glyphicon-'+d[e]+'"></span>');g.data("uiDataGridBindClick",
"loadPage").appendTo(c);a.uiDataGridTdPagination.childs.push(g[0])});a=c=d=null}},_updatePagination:function(){var a,c;this.options.pagination&&this._num_rows&&(this._totalPages=Math.ceil(this._num_rows/this.options.limit),a=0===this._offset?1:this._offset/this.options.limit+1,c=a+" de "+this._totalPages+" ("+this._num_rows+")",function(f){b.map(f.uiDataGridTdPagination.childs,function(d){/span/i.test(d.tagName)?b(d).text(c):/uiDataGridSetPage-(first|prev)/.test(d.name)?0<f._offset&&d.disabled&&(f.options.ui?
b(d).button("enable"):b(d).prop("disabled",!1)):f._totalPages>a&&(f.options.ui?b(d).button("enable"):b(d).prop("disabled",!1))})}(this))},_createToolBarButtons:function(){if(b.isArray(this.options.toolBarButtons)){var a=this,c=this.uiDataGridTfoot[0].rows[0].cells[0],f=a.options.ui;b.map(a.options.toolBarButtons,function(a,e){var h=b("<button></button>",{type:"button"});a.text=a.label||a.text;a.click=a.fn||a.click;delete a.fn;delete a.label;b.isFunction(a.click)&&h.data("uiDataGridBindClick","toolBarButtons:"+
e+":click");h.text(a.text);f?h.button({icons:{primary:k===a.icon?null:"ui-icon-"+a.icon}}):(h.addClass("btn btn-default btn-xs"),k!==a.icon&&h.prepend('<span class="glyphicon glyphicon-'+a.icon+'"></span> '));h.appendTo(c)});c=a=null}},_nextPage:function(){this._offset+=this.options.limit},_prevPage:function(){this._offset-=this.options.limit},_endPage:function(){this._offset=this._totalPages*this.options.limit-this.options.limit},_firstPage:function(){this._offset=0},_active:function(){return this.element.children(":eq(0)").hasClass("ui-datagrid-container")},
_getBHF:function(a,c){return b.isFunction(c)?c.call(a[0]):a},_message:function(a){this.uiDataGridTbody.empty();this.uiDataGridMsgError.text(a).addClass("show-message")},_ajax:function(){var a=this.options,c=a.jsonStore.url,f=a.limit,d=this._offset,e=a.jsonStore;this.clearSelectedRows();this.uiDataGridMsgError.removeClass("show-message");k===c||""===c?(c=(e.data.rows||e.data)[0],k===c||k===c[a.mapper[0].name]?this._message("Invalid JSON or empty data"):this._createRows(e.data,"local"),c=null):("string"===
typeof e.params?e.params=0===d?e.params+"&limit="+f+"&offset="+d:e.params.replace(/(&offset=)(.+)/,"&offset="+d):(k===e.params&&(e.params={}),e.params.limit=f,e.params.offset=d),b.ajax({type:a.ajaxMethod.toLowerCase(),url:c.replace(/\?.*/,""),data:e.params,dataType:"json",context:this,success:function(a){if(k!==a.error||0===a.length)return a=k!==a.error?a.error:0===a.length?this.options.emptyDataMessage:"Invalid JSON",b.isFunction(this.options.onError)?this.options.onError.call(this.element[0],a):
this._message(a),!1;this._createRows(a,"ajax");b.isFunction(this.options.onAjaxSuccess)&&this.options.onAjaxSuccess.call(this.element[0])}}))},render:function(){var a=this,c=0;a._active()?(a.resetOffset(),a.load()):(a._createToolBarButtons(),a.uiDataGrid.appendTo(a.element),a._createColumns(),a.resize(),a.options.autoLoad&&(c=180,setTimeout(function(a){return function(){a.load()}}(a),c)),b.isFunction(a.options.onComplete)&&setTimeout(function(a){return function(){a.options.onComplete.call(a.element[0])}}(a),
c++));a=null},resize:function(){this.options.fit&&function(a){a=a.uiDataGrid.outerHeight()-a.element.height();this.style.height=b(this).height()-a+"px"}.call(this.uiDataGridScrollBody[0],this)},selectRow:function(a){var c=b.inArray(a,this._selectedRows);-1<c?(this._selectedRows.splice(c,1),b(a).removeClass("ui-state-highlight")):(this._selectedRows.push(a),b(a).addClass("ui-state-highlight"))},clearSelectedRows:function(){this.getSelectedRows(!0).removeClass("ui-state-highlight");this._selectedRows=
[]},getSelectedRows:function(a){return!0===a?b(this._selectedRows):this._selectedRows},load:function(){this._ajax()},widget:function(){return this.uiDataGrid},getOffset:function(){return this._offset},resetOffset:function(){var a;this._offset=this._num_rows=0;!0===this.options.pagination&&(a=b(this.uiDataGridTdPagination.childs).filter("button"),this.options.ui?a.button("disable"):a.prop("disabled",!0))},getThead:function(a){return this._getBHF(this.uiDataGridThead,a)},getTbody:function(a){return this._getBHF(this.uiDataGridTbody,
a)},getTFoot:function(a){return this._getBHF(this.uiDataGridTfoot,a)},addRow:function(a){this._createRows(a,null,!0)},loadLocalData:function(a,c){this.resetOffset();this.options.jsonStore={url:"",params:{},data:a};this.load();b.isFunction(c)&&c.call([])},updateColumns:function(a){this.options.mapper=a;this.uiDataGridTbody.empty();this._createColumns();this.resetOffset()}},w=function(a){var b={ui:{container_cls:"ui-widget ui-widget-content ui-corner-all",title_element:'<div class="ui-datagrid-title"><div class="ui-widget-header">Title</div></div>',
table_cls:"",table_row_hover:""},bs:{container_cls:"panel panel-default",title_element:'<div class="ui-datagrid-title panel-heading">Title</div>',table_cls:"table table-bordered table-condensed",table_row_hover:" table-hover"}},b=b[/^(ui|bs)$/.test(a)?a:"ui"];return'<div class="ui-datagrid-container '+b.container_cls+'">'+b.title_element+'<div class="ui-datagrid-content"><div class="ui-datagrid-content-scroll"><div class="ui-datagrid-header ui-state-default"><table class="table"><thead><tr><th class="active"><table class="ui-datagrid '+
b.table_cls+'"><colgroup></colgroup><thead><tr role="rowheader" class="active"></tr></thead></table></th><th class="active"></th></tr></thead></table></div><div class="ui-widget-content ui-datagrid-body"><table class="ui-datagrid ui-front table'+b.table_cls+' ui-datagrid-gridlayout"><colgroup></colgroup><tbody><tr></tr></tbody></table><table class="ui-datagrid ui-front'+b.table_cls+b.table_row_hover+'"><colgroup></colgroup><thead><tr role="rowheader"></tr></thead><tbody></tbody></table><div class="ui-state-error ui-front"></div></div></div></div><div class="ui-widget ui-state-default ui-datagrid-tools"><table class="ui-datagrid '+
b.table_cls+'"><tbody><tr><td>&nbsp;</td><td><span></span></td></tr></tbody></table></div></div>'};if(b.widget){var v=Number(b.ui.version.replace(/[^0-9]/g,""));b.widget("ui.datagrid",{_setOption:function(a,c){"jsonStore"===a&&b.isPlainObject(c)?this.options.jsonStore=b.extend({},this.options.jsonStore,c):1.9<=v?this._super(a,c):b.Widget.prototype._setOption.apply(this,arguments)},_destroy:function(){1.9>v&&b.Widget.prototype.destroy.call(this);this.element.empty()}});r.options.ui=!0;b.widget("ui.datagrid",
b.ui.datagrid,r);r=null}else b.extend(b.expr[":"],{data:b.expr.createPseudo?b.expr.createPseudo(function(a){return function(c){return!!b.data(c,a)}}):function(a,c,f){return!!b.data(a,f[3])}}),b.fn.datagrid=function(a,c,f){var d=this;this.each(function(e,h){e=b.data(this,"jQueryDataGrid");h=this;if(k===e)b.data(this,"jQueryDataGrid",function(){this.options=b.extend({},this.options,a);this.element=b(h);this.ui=!1;this._create();this._init();return this}.call(r));else{var g,l=e;"string"===typeof a&&
("option"===a?k!==c&&(k!==f?l.options[c]=b.isPlainObject(f)?b.extend({},l.options[c],f):f:d=l.options[c]):(g=l[a].apply(l,[a]),g!==l&&g!==k&&(d=g&&/^get/i.test(a)?g:d.pushStack(g.get()))),g=l=null)}e=h=null});return d}})(jQuery,window,document);