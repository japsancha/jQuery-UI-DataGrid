/*!
 * jQuery datagrid
 * 
 * @autor:.....: Juarez Gon√ßalves Nery Junior
 * @email:.....: juareznjunior@gmail.com
 * @twitter:...: @juareznjunior
 * @date.......: 2014-10-13
 * 
 * Use jQueryUI - Depends:
 *  jquery.ui.core.js
 *  jquery.ui.widget.js
 *  jquery.ui.button.js
 * 
 */
;!function(a){"function"==typeof define&&define.amd?define(["jquery"],a):a(jQuery)}(function(a){"use strict";var b={options:{limit:20,mapper:[],height:200,jsonStore:{url:"",params:{},data:{}},pagination:!0,refresh:!1,rowNumber:!1,fit:!1,autoRender:!0,autoLoad:!0,ajaxMethod:"GET",title:"",onClickRow:!1,onComplete:!1,onAjaxSuccess:!1,onError:!1,emptyDataMessage:"Empty rows",toolBarButtons:!1,sort:!1,eventController:!1},_create:function(){"none"===this.element.css("display")&&this.element.show();var b,d=[];this.uiDataGrid=a(c()),this.uiDataGrid.find("table").filter(function(){a(this).hasClass("ui-datagrid")?d.push(this):b=this.parentNode.parentNode}).end(),""===this.options.title?a(b.parentNode).prev().remove():a(b.parentNode).prev().children().html(this.options.title),a.isArray(this.options.toolBarButtons)===!1&&this.options.pagination===!1&&a(d[3].parentNode).remove(),this.uiDataGridThead=a(d[0].tHead),this.uiDataGridLayout=a(d[1].tBodies[0].rows[0]),this.uiDataGridTheadBody=a(d[2].tHead),this.uiDataGridColGroup1=this.uiDataGridThead.prev(),this.uiDataGridColGroup2=a(this.uiDataGridLayout[0].parentNode).prev(),this.uiDataGridColGroup3=this.uiDataGridTheadBody.prev(),this.uiDataGridTbody=a(d[2].tBodies[0]),this.uiDataGridMsgError=a(d[2]).next(),this.uiDataGridTfoot=a(this.options.pagination||a.isArray(this.options.toolBarButtons)?d[3].tBodies[0]:[]),this.uiDataGridScrollBody=a(d[1].parentNode).height(this.options.height),this.uiDataGridScrollMain=a(b),this.uiDataGridTdPagination={childs:[]},this._selectedRows=[],d=b=null,this._num_rows=0,this._offset=0,this._totalPages=0,this._createPagination(),a.isPlainObject(this.options.jsonStore.params)&&(this.options.jsonStore.params=a.param(this.options.jsonStore.params))},_init:function(){this.options.autoRender&&this.render()},_createColumns:function(){var b=this,c=null,d=null,e="<col></col>",f='<th class="ui-widget ui-state-default" role="columnheader"></th>',g='<td class="ui-widget ui-widget-content"></td>',h="ui-datagrid-align-",i="ui-datagrid-column-hide",j=0,k=a([b.uiDataGridColGroup1[0],b.uiDataGridColGroup2[0],b.uiDataGridColGroup3[0]]).empty(),l=a([b.uiDataGridThead[0].rows[0],b.uiDataGridTheadBody[0].rows[0]]).empty(),m=100/b.options.mapper.length;b.uiDataGridLayout.empty(),b.options.rowNumber&&(k.append(a("<col></col>").addClass("ui-datagrid-cell-rownumber")),l.append('<th class="ui-state-default ui-datagrid-cell-rownumber" role="columnheader"></th>'),b.uiDataGridLayout.append(g)),a.map(b.options.mapper,function(j,n){d=j.title||j.name,n=n<b.options.mapper.length-1?isNaN(parseFloat(j.width))?m+"%":j.width:"",c=a(f).html(d),c=c.text(c.text()),c.data("text-align",h+(/left|right|center/.test(j.align)?j.align:"left")).addClass(function(){return a(this).data("textAlign")}),!0===j.sort&&c.addClass("ui-datagrid-sort ui-state-disabled").html(function(){return a("<button>"+this.innerHTML+"</button>",{type:"button"}).button({icons:{primary:"",secondary:"ui-icon-carat-2-n-s"}})});var o=a(g),p=a(e).width(n);void 0!==j.hidden&&a([c.data("hidden",i)[0],p[0],o[0]]).addClass(i),l.append(c),k.append(p),b.uiDataGridLayout.append(o),p=o=j=null}),b.uiDataGridColGroup1.children().map(function(){j+=a(this).width()}),j>b.element.width()&&b.uiDataGridScrollMain.width(j),j=m=0,a(b.uiDataGridTheadBody[0].parentNode.tHead).hide(),c=l=k=null,e=null,f=null,g=null,h=null,i=null,this._sort()},_createRows:function(b,c,d){var e,f,g=this,h=g.getThead()[0].rows[0].cells,i=d?g.uiDataGridTbody[0]:g.uiDataGridTbody.empty()[0],j="ui-widget ui-widget-content",k=d?i.rows.length+1:g._offset+1,l=!d&&"local"===c&&g.options.pagination;0===g._num_rows&&(g._num_rows=void 0===b.num_rows?void 0===b.rows?void 0===b[0].num_rows?b.length:b[0].num_rows:void 0===b.rows[0].num_rows?b.rows.length:b.rows[0].num_rows:b.num_rows),b=b.rows||b,l&&k>1&&(b=b.slice(g._offset)),a.map(b,function(b,c){return l&&c===g.options.limit?!1:(e=i.insertRow(-1),e.className="ui-state-hover",a(e).data("row-json",b).data("row-index",k+1),g.options.rowNumber&&a(e.insertCell(0)).addClass("ui-state-default ui-datagrid-cell-rownumber").text(k+c),a.isFunction(g.options.onClickRow)&&a(e).data("uiDataGridBindClick","onClickRow"),void a.map(g.options.mapper,function(c){f=e.insertCell(-1),f.className=j,a.map(a(h[f.cellIndex]).data(),function(a,b){/textAlign|text-align|hidden/.test(b)&&(f.className+=" "+a)}),a(f).html(a.isFunction(c.render)?c.render.call(f,b[c.name]):b[c.name])}))}),d||(this._updatePagination(),g.uiDataGridScrollBody.scrollTop(0)),a.isPlainObject(this.options.sort)&&a(this.uiDataGridThead[0].rows[0].cells).filter(".ui-datagrid-sort").removeClass("ui-state-disabled"),h=i=e=f=g=b=null},_createPagination:function(){if(!0===this.options.pagination){var b,c=this,d=a(this.uiDataGridTfoot[0].rows[0].cells).last()[0];c.uiDataGridTdPagination.childs.push(a(d).children()[0]),a.map(["first","prev","next","end"],function(e,f){b=f,f=a("<button></button>",{type:"button",name:"uiDataGridSetPage-"+e,disabled:!0}).text(e).button({icons:{primary:"ui-icon-seek-"+e},text:!1}).data("uiDataGridBindClick","loadPage").appendTo(d),c.uiDataGridTdPagination.childs.push(f[0]),f=null}),c=d=null}},_updatePagination:function(){var b,c;this.options.pagination&&this._num_rows&&(this._totalPages=Math.ceil(this._num_rows/this.options.limit),b=0===this._offset?1:this._offset/this.options.limit+1,c=b+" de "+this._totalPages+" ("+this._num_rows+")",function(d){a.map(d.uiDataGridTdPagination.childs,function(e){/span/i.test(e.tagName)?a(e).text(c):/uiDataGridSetPage-(first|prev)/.test(e.name)?d._offset>0&&e.disabled&&a(e).button("enable"):d._totalPages>b&&a(e).button("enable")})}(this))},_createToolBarButtons:function(){if(a.isArray(this.options.toolBarButtons)){var b=this,c=this.uiDataGridTfoot[0].rows[0].cells[0];a.map(b.options.toolBarButtons,function(b,d){var e=a("<button></button>",{type:"button"});b.label=b.label||b.text,b.click=b.fn||b.click,b.icons=b.icon?{primary:"ui-icon-"+b.icon}:{},delete b.fn,a.isFunction(b.click)&&e.data("uiDataGridBindClick","toolBarButtons:"+d+":click"),e.button(b).appendTo(c),e=null}),c=b=null}},_nextPage:function(){this._offset+=this.options.limit},_prevPage:function(){this._offset-=this.options.limit},_endPage:function(){this._offset=this._totalPages*this.options.limit-this.options.limit},_firstPage:function(){this._offset=0},_active:function(){return this.element.children(":eq(0)").hasClass("ui-datagrid-container")},_getBHF:function(b,c){return a.isFunction(c)?c.call(b[0]):b},_message:function(a){this.uiDataGridTbody.empty(),this.uiDataGridMsgError.text(a).addClass("show-message")},_ajax:function(){var b=this.options,c=b.jsonStore.url,d=b.limit,e=this._offset,f=b.jsonStore;return a.isPlainObject(this.options.sort)&&a(this.uiDataGridThead[0].rows[0].cells).filter(".ui-datagrid-sort").addClass("ui-state-disabled"),this.clearSelectedRows(),this.uiDataGridMsgError.removeClass("show-message"),void 0===c||""===c?(c=(f.data.rows||f.data)[0],void 0===c||void 0===c[b.mapper[0].name]?this._message("Invalid JSON or empty data"):this._createRows(f.data,"local"),void(c=null)):(f=null,this.addParam({limit:d,offset:e}),b=b.ajaxMethod.toLowerCase(),void a.ajax({type:b,url:c.replace(/\?.*/,""),data:this.options.jsonStore.params,dataType:"json",context:this,success:function(b){return void 0!==b.error||0===b.length?(b=void 0!==b.error?b.error:0===b.length?this.options.emptyDataMessage:"Invalid JSON",a.isFunction(this.options.onError)?this.options.onError.call(this.element[0],b):this._message(b),!1):(this._createRows(b,"ajax"),void(a.isFunction(this.options.onAjaxSuccess)&&this.options.onAjaxSuccess.call(this.element[0])))}}))},_sort:function(){function b(a){return a=a.cells.item(e).textContent.toLowerCase().replace(".","").replace(",","."),!1===isNaN(a)?parseFloat(a):a}function c(a,c){var d=b(a),e=b(c),f=parseInt(d,10);return f&&(d=f,e=parseInt(e,10)),d>e?1:e>d?-1:0}function d(b){var d=this.parentNode;if(!a(d).hasClass("ui-state-disabled")){var f,g,h,i=b.data.self,j=d.parentNode,k=a.data(j,"currentRowSort"),l=i.uiDataGridTbody[0],m=0,n=a(d).hasClass("tablesorter-headerAsc")?"tablesorter-headerDesc":"tablesorter-headerAsc",o=document.createDocumentFragment();if(a([d,void 0!==k&&d!==k?k:[]]).removeClass("tablesorter-header").removeClass("tablesorter-headerAsc").removeClass("tablesorter-headerDesc"),e=d.cellIndex,a.data(j,"currentRowSort",d),i.addParam("order="+i.options.mapper[e].name+"_"+n.replace("tablesorter-header","").toLowerCase()),!0===i.options.sort.remote&&i._num_rows>i.options.limit)i.load();else{for(f=l.rows,g=f.length,f=Array.prototype.sort.call(Array.prototype.slice.call(f,0),c),"tablesorter-headerDesc"===n&&Array.prototype.reverse.call(f);l.firstChild;)l.removeChild(l.firstChild);for(;h=f[m++];)o.appendChild(h);l.appendChild(o)}a(d).addClass("tablesorter-header "+n),o=null,i=null,j=null,d=null,k=null,l=null,h=null,f=null}}if(a.isPlainObject(this.options.sort)){var e,f=this.options.sort;/^[0-9]$/.test(parseInt(f.initial,10).toString())&&(e=f.initial,a.data(this.uiDataGridThead[0].rows[0],"currentRowSort",a(this.uiDataGridThead[0].rows[0].cells[e]).addClass("tablesorter-header tablesorter-header"+(/^(Desc|Asc)$/.test(f.direction)?f.direction:"Asc"))[0])),this.uiDataGridThead.on("click.uiDataGridEventSort",".ui-button.ui-button-text-icon-secondary",{self:this},d)}},_observer:function(){this.element.on("click.uiDataGridBindClick",function(b){var c,d,e=b.target,f=a(e).data("uiDataGridBindClick");void 0===f&&(f=a(e.parentNode).data("uiDataGridBindClick"),e=e.parentNode),void 0===f&&e.dataset&&(f=e.dataset.uiDataGridBindClick),void 0!==f&&(d=a(this).data("ui-datagrid"),"loadPage"===f?!1===e.disabled&&(c=a(d.uiDataGridTdPagination.childs).filter("button"),c.removeClass("ui-state-hover ui-state-focus").button("disable"),c=e.name.split("-").slice(-1),d["_"+c+"Page"](),d.load()):(c=d.options.eventController,/^toolBarButtons/.test(f)&&(c=d.options.toolBarButtons,f=f.replace("toolBarButtons:","")),a.map(f.split(":"),function(a){c=c[a]}),a.isFunction(c)&&c.call(this,e)),b.preventDefault(),b.stopPropagation()),f=c=d=e=null})},render:function(){var b=this,c=0;b._active()?(b.resetOffset(),b.load()):(b._createToolBarButtons(),b.uiDataGrid.appendTo(b.element),b._createColumns(),b._observer(),b.resize(),b.options.autoLoad&&(c=180,setTimeout(function(a){return function(){a.load()}}(b),c)),a.isFunction(b.options.onComplete)&&setTimeout(function(a){return function(){a.options.onComplete.call(a.element[0])}}(b),c++)),b=null},resize:function(){this.options.fit&&function(b){var c=b.uiDataGrid.outerHeight()-b.element.height();this.style.height=a(this).height()-c+"px"}.call(this.uiDataGridScrollBody[0],this)},selectRow:function(b){var c=this,d=a.inArray(b,this._selectedRows);d>-1?(this._selectedRows.splice(d,1),a(b).removeClass("ui-state-highlight")):(this._selectedRows.push(b),a(b).addClass("ui-state-highlight")),c=null},clearSelectedRows:function(){this.getSelectedRows(!0).removeClass("ui-state-highlight"),this._selectedRows=[]},getSelectedRows:function(b){return!0===b?a(this._selectedRows):this._selectedRows},load:function(){this._ajax()},widget:function(){return this.uiDataGrid},getOffset:function(){return this._offset},resetOffset:function(){this._num_rows=0,this._offset=0,!0===this.options.pagination&&a.map(this.uiDataGridTdPagination.childs,function(b){/span/i.test(b.tagName)?a(b).text(" "):a(b).button("disable")})},getThead:function(a){return this._getBHF(this.uiDataGridThead,a)},getTbody:function(a){return this._getBHF(this.uiDataGridTbody,a)},getTFoot:function(a){return this._getBHF(this.uiDataGridTfoot,a)},addRow:function(a){this._createRows(a,null,!0)},loadLocalData:function(b,c){this.resetOffset(),this.options.jsonStore={url:"",params:{},data:b},this.load(),a.isFunction(c)&&c.call([])},updateColumns:function(a){this.options.mapper=a,this.uiDataGridTbody.empty(),this._createColumns(),this.resetOffset()},addParam:function(b){function c(a,b,c){var d=new RegExp("([\\?|&]?)"+b+"=.*?(&|$)","i"),e="&";return a.match(d)?a.replace(d,"$1"+b+"="+c+"$2"):a+e+b+"="+c}var d=this.options.jsonStore.params;""!==d?"string"==typeof b?(b=b.replace(/^[\\?]/,"").split("&"),a.map(b,function(a){a=a.split("="),d=c(d,a[0],a[1])})):a.map(b,function(a,b){d=c(d,b,a)}):d="string"==typeof b?b:a.param(b),this.options.jsonStore.params=d,d=null}},c=function(){return'<div class="ui-datagrid-container ui-widget ui-widget-content ui-corner-all"><div class="ui-datagrid-title"><div class="ui-widget-header">Title</div></div><div class="ui-datagrid-content"><div class="ui-datagrid-content-scroll"><div class="ui-datagrid-header ui-state-default"><table><thead><tr><th><table class="ui-datagrid"><colgroup></colgroup><thead><tr role="rowheader" class="active"></tr></thead></table></th><th></th></tr></thead></table></div><div class="ui-widget-content ui-datagrid-body"><table class="ui-datagrid ui-front ui-datagrid-gridlayout"><colgroup></colgroup><tbody><tr></tr></tbody></table><table class="ui-datagrid ui-front"><colgroup></colgroup><thead><tr role="rowheader"></tr></thead><tbody></tbody></table><div class="ui-state-error ui-front"></div></div></div></div><div class="ui-widget ui-state-default ui-datagrid-tools"><table class="ui-datagrid"><tbody><tr><td>&nbsp;</td><td><span></span></td></tr></tbody></table></div></div>'},d=Number(a.ui.version.replace(/[^0-9]/g,""));a.widget("ui.datagrid",{_setOption:function(b,c){var e;"jsonStore"===b&&a.isPlainObject(c)?(e=this.options.jsonStore=a.extend({},this.options.jsonStore,c),a.isPlainObject(e.params)&&(this.options.jsonStore.params=a.param(e.params)),e=null):d>=1.9?this._super(b,c):a.Widget.prototype._setOption.apply(this,arguments)},_destroy:function(){1.9>d&&a.Widget.prototype.destroy.call(this),this.element.empty()}}),a.widget("ui.datagrid",a.ui.datagrid,b),b=null});