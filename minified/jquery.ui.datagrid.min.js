/*!
 * jQuery datagrid
 * 
 * @autor:.....: Juarez Gon√ßalves Nery Junior
 * @email:.....: juareznjunior@gmail.com
 * @twitter:...: @juareznjunior
 * @date.......: 2014-11-10
 * 
 * Use jQueryUI - Depends:
 *	 jquery.ui.core.js
 *	 jquery.ui.widget.js
 *	 jquery.ui.button.js
 * 
 */
;(function(b){"function"===typeof define&&define.amd?define(["jquery"],b):b(jQuery)})(function(b){var q={options:{limit:20,mapper:[],height:200,jsonStore:{url:"",params:{},data:{}},pagination:!0,refresh:!1,rowNumber:!1,fit:!1,autoRender:!0,autoLoad:!0,ajaxMethod:"GET",title:"",onClickRow:!1,onComplete:!1,onAjaxSuccess:!1,onError:!1,emptyDataMessage:"Empty rows",toolBarButtons:!1,sort:!1,eventController:!1},_create:function(){"none"===this.element.css("display")&&this.element.show();var a=[],c;this.uiDataGrid=
b('<div class="ui-datagrid-container ui-widget ui-widget-content ui-corner-all"><div class="ui-datagrid-title"><div class="ui-widget-header">Title</div></div><div class="ui-datagrid-content"><div class="ui-datagrid-content-scroll"><div class="ui-datagrid-header ui-state-default"><table><thead><tr><th><table class="ui-datagrid"><colgroup></colgroup><thead><tr role="rowheader" class="active"></tr></thead></table></th><th></th></tr></thead></table></div><div class="ui-widget-content ui-datagrid-body"><table class="ui-datagrid ui-front ui-datagrid-gridlayout"><colgroup></colgroup><tbody><tr></tr></tbody></table><table class="ui-datagrid ui-front"><colgroup></colgroup><thead><tr role="rowheader"></tr></thead><tbody></tbody></table><div class="ui-state-error ui-front"></div></div></div></div><div class="ui-widget ui-state-default ui-datagrid-tools"><table class="ui-datagrid"><tbody><tr><td>&nbsp;</td><td><span></span></td></tr></tbody></table></div></div>');
this.uiDataGrid.find("table").filter(function(){b(this).hasClass("ui-datagrid")?a.push(this):c=this.parentNode.parentNode}).end();""===this.options.title?b(c.parentNode).prev().remove():b(c.parentNode).prev().children().html(this.options.title);!1===b.isArray(this.options.toolBarButtons)&&!1===this.options.pagination&&b(a[3].parentNode).remove();this.uiDataGridThead=b(a[0].tHead);this.uiDataGridLayout=b(a[1].tBodies[0].rows[0]);this.uiDataGridTheadBody=b(a[2].tHead);this.uiDataGridColGroup1=this.uiDataGridThead.prev();
this.uiDataGridColGroup2=b(this.uiDataGridLayout[0].parentNode).prev();this.uiDataGridColGroup3=this.uiDataGridTheadBody.prev();this.uiDataGridTbody=b(a[2].tBodies[0]);this.uiDataGridMsgError=b(a[2]).next();this.uiDataGridTfoot=this.options.pagination||b.isArray(this.options.toolBarButtons)?b(a[3].tBodies[0]):b([]);this.uiDataGridScrollBody=b(a[1].parentNode).height(this.options.height);this.uiDataGridScrollMain=b(c);this.uiDataGridTdPagination={childs:[]};this._selectedRows=[];a=c=null;this._totalPages=
this._offset=this._num_rows=0;this._createPagination();b.isPlainObject(this.options.jsonStore.params)&&(this.options.jsonStore.params=b.param(this.options.jsonStore.params))},_init:function(){!0===this.options.autoRender&&this.render()},_createColumns:function(){var a=this,c=null,d=null,e="<col></col>",f='<th class="ui-widget ui-state-default" role="columnheader"></th>',k='<td class="ui-widget ui-widget-content"></td>',l="ui-datagrid-align-",m="ui-datagrid-column-hide",g=0,h=b([a.uiDataGridColGroup1[0],
a.uiDataGridColGroup2[0],a.uiDataGridColGroup3[0]]).empty(),p=b([a.uiDataGridThead[0].rows[0],a.uiDataGridTheadBody[0].rows[0]]).empty(),n=100/a.options.mapper.length;a.uiDataGridLayout.empty();a.options.rowNumber&&(h.append(b("<col></col>").addClass("ui-datagrid-cell-rownumber")),p.append('<th class="ui-state-default ui-datagrid-cell-rownumber" role="columnheader"></th>'),a.uiDataGridLayout.append(k));b.map(a.options.mapper,function(g,r){d=g.title||g.name;r=r<a.options.mapper.length-1?isNaN(parseFloat(g.width))?
n+"%":g.width:"";c=b(f).html(d);c=c.text(c.text());c.data("text-align",l+(/left|right|center/.test(g.align)?g.align:"left")).addClass(function(){return b(this).data("textAlign")});!0===g.sort&&c.addClass("ui-datagrid-sort ui-state-disabled").html(function(a){return b("<button>"+this.innerHTML+"</button>",{type:"button"}).button({icons:{primary:"",secondary:"ui-icon-carat-2-n-s"}})});var s=b(k),t=b(e).width(r);void 0!==g.hidden&&b([c.data("hidden",m)[0],t[0],s[0]]).addClass(m);p.append(c);h.append(t);
a.uiDataGridLayout.append(s);t=s=g=null});a.uiDataGridColGroup1.children().map(function(){g+=b(this).width()});g>a.element.width()&&a.uiDataGridScrollMain.width(g);g=n=0;b(a.uiDataGridTheadBody[0].parentNode.tHead).hide();m=l=k=f=e=c=p=h=null;this._sort()},_createRows:function(a,c,d){var e=this,f=e.getThead()[0].rows[0].cells,k=d?e.uiDataGridTbody[0]:e.uiDataGridTbody.empty()[0],l=d?k.rows.length+1:e._offset+1,m=!d&&"local"===c&&e.options.pagination,g,h;0===e._num_rows&&(e._num_rows=void 0===a.num_rows?
void 0===a.rows?void 0===a[0].num_rows?a.length:a[0].num_rows:void 0===a.rows[0].num_rows?a.rows.length:a.rows[0].num_rows:a.num_rows);a=a.rows||a;m&&1<l&&(a=a.slice(e._offset));b.map(a,function(a,c){if(m&&c===e.options.limit)return!1;g=k.insertRow(-1);g.className="ui-state-hover";b(g).data("row-json",a).data("row-index",l+1);e.options.rowNumber&&b(g.insertCell(0)).addClass("ui-state-default ui-datagrid-cell-rownumber").text(l+c);b.isFunction(e.options.eventController.onClickRow)&&b(g).data("uiDataGridBindClick",
"onClickRow");b.map(e.options.mapper,function(c,d){h=g.insertCell(-1);h.className="ui-widget ui-widget-content";b.map(b(f[h.cellIndex]).data(),function(a,b){/textAlign|text-align|hidden/.test(b)&&(h.className+=" "+a)});b(h).html(b.isFunction(c.render)?c.render.call(h,a[c.name]):a[c.name])})});d||(this._updatePagination(),e.uiDataGridScrollBody.scrollTop(0));b.isPlainObject(this.options.sort)&&b(this.uiDataGridThead[0].rows[0].cells).filter(".ui-datagrid-sort").removeClass("ui-state-disabled");f=k=
g=h=e=a=null},_createPagination:function(){if(!0===this.options.pagination){var a=this,c=b(this.uiDataGridTfoot[0].rows[0].cells).last()[0];a.uiDataGridTdPagination.childs.push(b(c).children()[0]);b.map(["first","prev","next","end"],function(d,e){e=b("<button></button>",{type:"button",name:"uiDataGridSetPage-"+d,disabled:!0}).text(d).button({icons:{primary:"ui-icon-seek-"+d},text:!1}).data("uiDataGridBindClick","loadPage").appendTo(c);a.uiDataGridTdPagination.childs.push(e[0])});a=c=null}},_updatePagination:function(){var a,
c;this.options.pagination&&this._num_rows&&(this._totalPages=Math.ceil(this._num_rows/this.options.limit),a=0===this._offset?1:this._offset/this.options.limit+1,c=a+" de "+this._totalPages+" ("+this._num_rows+")",function(d){b.map(d.uiDataGridTdPagination.childs,function(e){/span/i.test(e.tagName)?b(e).text(c):/uiDataGridSetPage-(first|prev)/.test(e.name)?0<d._offset&&e.disabled&&b(e).button("enable"):d._totalPages>a&&b(e).button("enable")})}(this))},_createToolBarButtons:function(){if(b.isArray(this.options.toolBarButtons)){var a=
this.uiDataGridTfoot[0].rows[0].cells[0];b.map(this.options.toolBarButtons,function(c,d){var e=b("<button></button>",{type:"button"});c.label=c.label||c.text;c.click=c.fn||c.click;c.icons=c.icon?{primary:"ui-icon-"+c.icon}:{};delete c.fn;b.isFunction(c.click)&&e.data("uiDataGridBindClick","toolBarButtons:"+d+":click");e.button(c).appendTo(a)});a=null}},_nextPage:function(){this._offset+=this.options.limit},_prevPage:function(){this._offset-=this.options.limit},_endPage:function(){this._offset=this._totalPages*
this.options.limit-this.options.limit},_firstPage:function(){this._offset=0},_active:function(){return this.element.children(":eq(0)").hasClass("ui-datagrid-container")},_getBHF:function(a,c){return b.isFunction(c)?c.call(a[0]):a},_message:function(a){this.uiDataGridTbody.empty();this.uiDataGridMsgError.text(a).addClass("show-message")},_ajax:function(){var a=this.options,c=a.jsonStore.url,d=a.limit,e=this._offset,f=a.jsonStore;b.isPlainObject(this.options.sort)&&b(this.uiDataGridThead[0].rows[0].cells).filter(".ui-datagrid-sort").addClass("ui-state-disabled");
this.clearSelectedRows();this.uiDataGridMsgError.removeClass("show-message");void 0===c||""===c?(c=(f.data.rows||f.data)[0],void 0===c||void 0===c[a.mapper[0].name]?this._message("Invalid JSON or empty data"):this._createRows(f.data,"local"),c=null):(f=null,this.addParam({limit:d,offset:e}),a=a.ajaxMethod.toLowerCase(),b.ajax({type:a,url:c.replace(/\?.*/,""),data:this.options.jsonStore.params,dataType:"json",context:this,success:function(a){if(void 0!==a.error||0===a.length)return a=void 0!==a.error?
a.error:0===a.length?this.options.emptyDataMessage:"Invalid JSON",b.isFunction(this.options.onError)?this.options.onError.call(this.element[0],a):this._message(a),!1;this._createRows(a,"ajax");b.isFunction(this.options.onAjaxSuccess)&&this.options.onAjaxSuccess.call(this.element[0])}}))},_sort:function(){function a(a){a=a.cells.item(e).textContent.toLowerCase().replace(".","").replace(",",".");return!1===isNaN(a)?parseFloat(a):a}function c(b,c){var d=a(b),e=a(c),f=parseInt(d,10);f&&(d=f,e=parseInt(e,
10));return d>e?1:d<e?-1:0}function d(a){var d=this.parentNode;if(!b(d).hasClass("ui-state-disabled")){var f=a.data.self,g=d.parentNode,h=b.data(g,"currentRowSort");a=f.uiDataGridTbody[0];var p=0,n=b(d).hasClass("tablesorter-headerAsc")?"tablesorter-headerDesc":"tablesorter-headerAsc",q=document.createDocumentFragment();b([d,void 0!==h&&d!==h?h:[]]).removeClass("tablesorter-header").removeClass("tablesorter-headerAsc").removeClass("tablesorter-headerDesc");e=d.cellIndex;b.data(g,"currentRowSort",
d);f.addParam("order="+f.options.mapper[e].name+"_"+n.replace("tablesorter-header","").toLowerCase());if(!0===f.options.sort.remote&&f._num_rows>f.options.limit)f.load();else{f=a.rows;f=Array.prototype.sort.call(Array.prototype.slice.call(f,0),c);for("tablesorter-headerDesc"===n&&Array.prototype.reverse.call(f);a.firstChild;)a.removeChild(a.firstChild);for(;g=f[p++];)q.appendChild(g);a.appendChild(q)}b(d).addClass("tablesorter-header "+n)}}if(b.isPlainObject(this.options.sort)){var e,f=this.options.sort;
/^[0-9]$/.test(parseInt(f.initial,10).toString())&&(e=f.initial,b.data(this.uiDataGridThead[0].rows[0],"currentRowSort",b(this.uiDataGridThead[0].rows[0].cells[e]).addClass("tablesorter-header tablesorter-header"+(/^(Desc|Asc)$/.test(f.direction)?f.direction:"Asc"))[0]));this.uiDataGridThead.on("click.uiDataGridEventSort",".ui-button.ui-button-text-icon-secondary",{self:this},d)}},_eventObserve:function(a){this._on(this.uiDataGridTbody,{click:this._setupGridEvents});!0===this.options.pagination&&
this._on(this.uiDataGridTfoot[0].rows[0].cells[1],{click:this._setupGridEvents});b.isArray(this.options.toolBarButtons)&&this._on(this.uiDataGridTfoot[0].rows[0].cells[0],{click:this._setupGridEvents})},_setupGridEvents:function(a){var c=a.target,d=b(c).data("uiDataGridBindClick"),e="checkbox"===c.type||"radio"===c.type;void 0===d&&c.dataset&&(d=c.dataset.uiDataGridBindClick);if(void 0===d&&(c=b(c).closest(":data(uiDataGridBindClick)")[0],d=b(c).data("uiDataGridBindClick"),"onClickRow"===d))return this.options.eventController.onClickRow.call(this.element[0],
c,a),e;if(void 0!==d)if("loadPage"===d)!1===c.disabled&&(d=b(this.uiDataGridTdPagination.childs).filter("button"),d.removeClass("ui-state-hover ui-state-focus").button("disable"),d=c.name.split("-").slice(-1),this["_"+d+"Page"](),this.load());else if(d=/^toolBarButtons/.test(d)?this.options.toolBarButtons[d.replace(/[^0-9]/g,"")].click||!1:this.options.eventController[d]||!1,b.isFunction(d))return d.call(this.element[0],c,a),e},render:function(){var a=this,c=0;a._active()?(a.resetOffset(),a.load()):
(a._createToolBarButtons(),a.uiDataGrid.appendTo(a.element),a._createColumns(),a._eventObserve(),a.resize(),!0===a.options.autoLoad&&(c=180,setTimeout(function(a){return function(){a.load()}}(a),c)),b.isFunction(a.options.onComplete)&&setTimeout(function(a){return function(){a.options.onComplete.call(a.element[0])}}(a),c++));a=null},resize:function(){this.options.fit&&function(a){a=a.uiDataGrid.outerHeight()-a.element.height();this.style.height=b(this).height()-a+"px"}.call(this.uiDataGridScrollBody[0],
this)},selectRow:function(a){var c=b.inArray(a,this._selectedRows);-1<c?(this._selectedRows.splice(c,1),b(a).removeClass("ui-state-highlight")):(this._selectedRows.push(a),b(a).addClass("ui-state-highlight"))},clearSelectedRows:function(){this.getSelectedRows(!0).removeClass("ui-state-highlight");this._selectedRows=[]},getSelectedRows:function(a){return!0===a?b(this._selectedRows):this._selectedRows},load:function(){this._ajax()},widget:function(){return this.uiDataGrid},getOffset:function(){return this._offset},
resetOffset:function(){this._offset=this._num_rows=0;!0===this.options.pagination&&b.map(this.uiDataGridTdPagination.childs,function(a){/span/i.test(a.tagName)?b(a).text(" "):b(a).button("disable")})},getThead:function(a){return this._getBHF(this.uiDataGridThead,a)},getTbody:function(a){return this._getBHF(this.uiDataGridTbody,a)},getTFoot:function(a){return this._getBHF(this.uiDataGridTfoot,a)},addRow:function(a){this._createRows(a,null,!0)},loadLocalData:function(a,c){this.resetOffset();this.options.jsonStore=
{url:"",params:{},data:a};this.load();b.isFunction(c)&&c.call([])},updateColumns:function(a){this.options.mapper=a;this.uiDataGridTbody.empty();this._createColumns();this.resetOffset()},addParam:function(a){function c(a,b,c){var d=new RegExp("([\\?|&]?)"+b+"=.*?(&|$)","i");return a.match(d)?a.replace(d,"$1"+b+"="+c+"$2"):a+"&"+b+"="+c}var d=this.options.jsonStore.params;""!==d?"string"===typeof a?(a=a.replace(/^[\\?]/,"").split("&"),b.map(a,function(a){a=a.split("=");d=c(d,a[0],a[1])})):b.map(a,function(a,
b){d=c(d,b,a)}):d="string"===typeof a?a:b.param(a);this.options.jsonStore.params=d;d=null}};b.widget("ui.datagrid",{_setOption:function(a,c){var d;"jsonStore"===a&&b.isPlainObject(c)&&(d=this.options.jsonStore=b.extend({},this.options.jsonStore,c),b.isPlainObject(d.params)&&(this.options.jsonStore.params=b.param(d.params)));this._super(a,c);"title"===a&&this.uiDataGridScrollMain.parent().prev().children().html(c)},_destroy:function(){this.element.empty()}});b.widget("ui.datagrid",b.ui.datagrid,q);
q=null});